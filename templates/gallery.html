<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ content.gallery_page.title }} - {{ content.site.title }}</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/theme.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/isotope-layout@3.0.6/dist/isotope.pkgd.min.js"></script>
    <script src="https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>
    <script src="/static/gallery.js"></script>
    <script src="/static/metadata.js" defer></script>
</head>
<body>
    <nav>
        <a href="/">
			<div class="logo">
				<img src="/static/logo.svg" alt="{{ content.navigation.logo_alt }}" onerror="this.src='https://via.placeholder.com/40'; this.onerror='';">
				<span>{{ content.navigation.site_name }} - {{ content.gallery_page.title }}</span>
			</div>
		</a>
        <div class="filter-buttons">
			<a href="{{ request.path }}?{% if current_folder %}folder={{ current_folder }}&{% endif %}display=all" class="filter-btn">
                <button class="{% if not media_type or media_type == 'all' %}filter-active{% endif %}">
                    All ({{ total_count }})
                </button>
            </a>
			<a href="{{ request.path }}?{% if current_folder %}folder={{ current_folder }}&{% endif %}display=videos" class="filter-btn">
                <button class="{% if media_type == 'videos' %}filter-active{% endif %}">
                    Videos ({{ video_count }})
                </button>
            </a>
			<a href="{{ request.path }}?{% if current_folder %}folder={{ current_folder }}&{% endif %}display=images" class="filter-btn">
                <button class="{% if media_type == 'images' %}filter-active{% endif %}">
                    Images ({{ image_count }})
                </button>
            </a>
			<select id="folder-dropdown" onchange="navigateToFolder(this.value)">
				<option value="">{{ content.gallery_page.all_folders }}</option>
				{% for folder in folders %}
				<option value="{{ folder }}" {% if folder == current_folder %}selected{% endif %}>
					{{ folder }}
				</option>
				{% endfor %}
			</select>
		</div>
	<script>
		function navigateToFolder(folder) {
            const params = new URLSearchParams(window.location.search);
            
            // Preserve the display parameter if it exists
            const display = params.get('display');

            // Reset parameters
            params.delete('folder');
            params.delete('page');
            params.delete('display');
            
            // Add folder parameter if selected
            if (folder) {
                params.set('folder', folder);
            }
            
            // Restore display parameter if it was set
            if (display) {
                params.set('display', display);
            }

            // Navigate to the new URL
            window.location.href = `${window.location.pathname}?${params.toString()}`;
        }
	</script>
    </nav>

    <!-- Initial Loading Spinner -->
    <div class="initial-loading" id="initialLoading">
        <div class="spinner"></div>
        <div class="loading-text">Loading gallery...</div>
    </div>

    <div class="grid">
        <div class="grid-sizer"></div>
        {% for item in media_files %}
            {% if item.path.endswith('.mp4') or item.path.endswith('.mov') or item.path.endswith('.avi') or item.path.endswith('.mkv') %}
                <div class="grid-item video-item"
                     style="aspect-ratio: {{ item.width }} / {{ item.height }};">
                    <a href="/media/{{ item.path }}" class="glightbox" data-gallery="gallery" data-type="video">
                        <img src="{{ item.thumbnail if item.thumbnail else placeholder }}"
                             alt="Video Thumbnail"
                             width="{{ item.width }}"
                             height="{{ item.height }}">
                    </a>
                </div>
            {% else %}
                <div class="grid-item image-item"
                     style="aspect-ratio: {{ item.width }} / {{ item.height }};">
                    <a href="/media/{{ item.path }}" class="glightbox" data-gallery="gallery">
                        <img src="{{ item.thumbnail }}"
                             alt="Image"
                             width="{{ item.width }}"
                             height="{{ item.height }}">
                    </a>
                </div>
            {% endif %}
        {% endfor %}
    </div>
    
	<div class="pagination">
		{% if page > 1 %}
			<a href="{{ request.path }}?page={{ page - 1 }}{% if current_folder %}&folder={{ current_folder }}{% endif %}{% if media_type %}&display={{ media_type }}{% endif %}">Previous</a>
		{% endif %}
		{% for p in range(page - 2, page + 3) if 1 <= p <= total_pages %}
			<a href="{{ request.path }}?page={{ p }}{% if current_folder %}&folder={{ current_folder }}{% endif %}{% if media_type %}&display={{ media_type }}{% endif %}"
			   {% if p == page %}class="active"{% endif %}>
			   {{ p }}
			</a>
		{% endfor %}
		{% if page < total_pages %}
			<a href="{{ request.path }}?page={{ page + 1 }}{% if current_folder %}&folder={{ current_folder }}{% endif %}{% if media_type %}&display={{ media_type }}{% endif %}">Next</a>
		{% endif %}
	</div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize gallery using shared helper
            initializeGallery();
            // All setup (Isotope, GLightbox, spinner hiding, resize handler) is done!
        });
    </script>
</body>
</html>
