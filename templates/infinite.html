<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ content.views.infinite.title }} - {{ content.site.title }}</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/theme.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/isotope-layout@3.0.6/dist/isotope.pkgd.min.js"></script>
    <script src="https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>
    <script src="/static/gallery.js"></script>
    <script src="/static/metadata.js" defer></script>
</head>
<body>
    <nav>
        <a href="/">
            <div class="logo">
                <img src="/static/logo.svg" alt="{{ content.navigation.logo_alt }}" onerror="this.src='https://via.placeholder.com/40'; this.onerror='';">
                <span>{{ content.navigation.site_name }} - {{ content.views.infinite.title }}</span>
            </div>
        </a>
        <div class="filter-buttons">
            <a href="/" style="color: white; background: rgba(0, 0, 0, 0.2); padding: 8px 15px; border-radius: 8px;">Back to Home</a>
        </div>
    </nav>

    <!-- Initial Loading Spinner -->
    <div class="initial-loading" id="initialLoading">
        <div class="spinner"></div>
        <div class="loading-text">Loading gallery...</div>
    </div>

    <div class="grid">
        <div class="grid-sizer"></div>
        {% for item in media_files %}
            <div class="grid-item {{ 'video' if item.path.endswith('.mp4') else 'image' }}"
                 style="aspect-ratio: {{ item.width }} / {{ item.height }};">
                <a href="/media/{{ item.path }}" class="glightbox" data-gallery="gallery">
                    <img src="{{ item.thumbnail }}"
                         alt="Media Thumbnail"
                         width="{{ item.width }}"
                         height="{{ item.height }}">
                </a>
            </div>
        {% endfor %}
    </div>
    <div class="loading" id="loading">Loading...</div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize gallery using shared helper
            const { iso, lightbox, grid } = initializeGallery();
            let currentLightbox = lightbox;

            // Infinite scroll implementation
            let currentPage = 1;
            let isLoading = false;

            const loadMoreItems = async () => {
                if (isLoading) return;

                isLoading = true;
                document.getElementById('loading').style.display = 'block';

                try {
                    const response = await fetch(`/gallery-data?page=${currentPage + 1}&sort=new`);
                    const data = await response.json();

                    data.media.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = `grid-item ${item.path.endsWith('.mp4') ? 'video' : 'image'}`;
                        itemDiv.style.aspectRatio = `${item.width} / ${item.height}`;
                        itemDiv.innerHTML = `
                            <a href="/media/${item.path}" class="glightbox" data-gallery="gallery">
                                <img src="${item.thumbnail}"
                                     alt="Media Thumbnail"
                                     width="${item.width}"
                                     height="${item.height}">
                            </a>`;
                        grid.appendChild(itemDiv);
                    });

                    // Get newly added items
                    const newItems = Array.from(grid.querySelectorAll('.grid-item'))
                        .slice(-data.media.length);

                    // Add new items to Isotope and layout
                    iso.appended(newItems);
                    iso.layout();

                    // Add info icons to new items
                    if (window.addInfoIcons) {
                        window.addInfoIcons();
                    }

                    // Re-layout when new images load (minor adjustments)
                    imagesLoaded(newItems, () => {
                        iso.layout();
                    });

                    // Reinitialize GLightbox for new items
                    currentLightbox = initializeGLightbox();

                    currentPage++;
                    if (!data.has_next) {
                        document.getElementById('loading').style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error loading more items:', error);
                } finally {
                    isLoading = false;
                }
            };

            window.addEventListener('scroll', () => {
                if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
                    loadMoreItems();
                }
            });

            // Resize handler is set up by initializeGallery()
        });
    </script>
</body>
</html>
