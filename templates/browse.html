<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse - Py Home Gallery</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/theme.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            background: var(--bg-page);
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .browse-container {
            margin-top: 100px;
            height: calc(100vh - 100px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* 3D Carousel Container */
        .carousel-container {
            perspective: 1400px;
            width: 100%;
            height: 720px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .carousel-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.1s ease-out;
        }

        /* Individual Folder Cards */
        .folder-card {
            position: absolute;
            width: 420px;
            height: 600px;
            left: 50%;
            top: 50%;
            margin-left: -210px;
            margin-top: -300px;
            background: var(--glass-bg);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-radius: 0;
            border: 2px solid var(--glass-border);
            box-shadow: 0 8px 32px var(--glass-shadow);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
            cursor: pointer;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }


        .folder-card img {
            width: 100%;
            flex: 1;
            min-height: 0;
            object-fit: cover;
            border-radius: 0;
            pointer-events: none;
            -webkit-user-drag: none;
            user-select: none;
            display: block;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .folder-info {
            flex-shrink: 0;
            padding: 1.25rem 1rem 1rem 1rem;
            text-align: center;
            background: transparent;
            box-sizing: border-box;
        }

        .folder-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .folder-count {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Card positions - will be set via JavaScript */
        .folder-card.active {
            z-index: 10;
            opacity: 1;
            transform: translateX(0) rotateY(0deg) scale(1) translateZ(0);
        }

        /* Hover effect for active card */
        .folder-card.active:hover {
            transform: translateX(0) rotateY(0deg) scale(1.05) translateZ(20px);
            box-shadow: 0 16px 48px var(--glass-shadow);
            border-color: var(--primary);
        }

        /* Hover effect for side cards */
        .folder-card.left-1:hover,
        .folder-card.right-1:hover {
            box-shadow: 0 12px 40px var(--glass-shadow);
        }

        .folder-card.left-2:hover,
        .folder-card.right-2:hover,
        .folder-card.left-3:hover,
        .folder-card.right-3:hover {
            box-shadow: 0 10px 36px var(--glass-shadow);
        }

        .folder-card.left-1 {
            z-index: 8;
            opacity: 1;
            transform: translateX(-280px) rotateY(40deg) scale(0.9) translateZ(-120px);
        }

        .folder-card.left-2 {
            z-index: 6;
            opacity: 1;
            transform: translateX(-460px) rotateY(50deg) scale(0.75) translateZ(-220px);
        }

        .folder-card.left-3 {
            z-index: 4;
            opacity: 1;
            transform: translateX(-600px) rotateY(60deg) scale(0.65) translateZ(-320px);
        }

        .folder-card.right-1 {
            z-index: 8;
            opacity: 1;
            transform: translateX(280px) rotateY(-40deg) scale(0.9) translateZ(-120px);
        }

        .folder-card.right-2 {
            z-index: 6;
            opacity: 1;
            transform: translateX(460px) rotateY(-50deg) scale(0.75) translateZ(-220px);
        }

        .folder-card.right-3 {
            z-index: 4;
            opacity: 1;
            transform: translateX(600px) rotateY(-60deg) scale(0.65) translateZ(-320px);
        }

        .folder-card.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateX(0) rotateY(0deg) scale(0.5) translateZ(-500px);
        }

        /* Intro animation for cards */
        @keyframes cardIntro {
            0% {
                opacity: 0;
                transform: translateY(50px) scale(0.8);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .folder-card.intro {
            animation: cardIntro 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        /* Stagger animation delays */
        .folder-card.intro:nth-child(1) { animation-delay: 0s; }
        .folder-card.intro:nth-child(2) { animation-delay: 0.1s; }
        .folder-card.intro:nth-child(3) { animation-delay: 0.2s; }
        .folder-card.intro:nth-child(4) { animation-delay: 0.3s; }
        .folder-card.intro:nth-child(5) { animation-delay: 0.4s; }
        .folder-card.intro:nth-child(6) { animation-delay: 0.5s; }
        .folder-card.intro:nth-child(7) { animation-delay: 0.6s; }
        .folder-card.intro:nth-child(n+8) { animation-delay: 0.7s; }


        /* Navigation Controls */
        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 100;
        }

        .carousel-nav.left {
            left: 2rem;
        }

        .carousel-nav.right {
            right: 2rem;
        }

        .nav-button {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background: var(--glass-bg);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border: 2px solid var(--glass-border);
            color: var(--text-primary);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px var(--glass-shadow);
        }

        .nav-button:hover {
            transform: scale(1.1);
            border-color: var(--primary);
            box-shadow: 0 6px 24px var(--glass-shadow);
        }

        .nav-button:active {
            transform: scale(0.95);
        }

        /* Loading State */
        .loading {
            text-align: center;
            color: var(--text-secondary);
            font-size: 1.2rem;
        }

        .loading .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid var(--glass-border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Info Display */
        .browse-info {
            margin-top: 2rem;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Large Screens (1920px - Full HD) */
        @media (min-width: 1600px) {
            .carousel-container {
                height: 900px;
                perspective: 1800px;
            }

            .folder-card {
                width: 540px;
                height: 780px;
                margin-left: -270px;
                margin-top: -390px;
            }

            .folder-info {
                padding: 1.5rem 1.25rem 1.25rem 1.25rem;
            }

            .folder-name {
                font-size: 1.35rem;
            }

            .folder-count {
                font-size: 1.05rem;
            }

            /* Adjust spacing for larger cards */
            .folder-card.left-1 {
                transform: translateX(-360px) rotateY(40deg) scale(0.9) translateZ(-120px);
            }

            .folder-card.left-2 {
                transform: translateX(-580px) rotateY(50deg) scale(0.75) translateZ(-220px);
            }

            .folder-card.left-3 {
                transform: translateX(-760px) rotateY(60deg) scale(0.65) translateZ(-320px);
            }

            .folder-card.right-1 {
                transform: translateX(360px) rotateY(-40deg) scale(0.9) translateZ(-120px);
            }

            .folder-card.right-2 {
                transform: translateX(580px) rotateY(-50deg) scale(0.75) translateZ(-220px);
            }

            .folder-card.right-3 {
                transform: translateX(760px) rotateY(-60deg) scale(0.65) translateZ(-320px);
            }

            .nav-button {
                width: 70px;
                height: 70px;
                font-size: 1.75rem;
            }
        }

        /* 4K Screens (2560px+) */
        @media (min-width: 2400px) {
            .carousel-container {
                height: 1140px;
                perspective: 2200px;
            }

            .folder-card {
                width: 660px;
                height: 960px;
                margin-left: -330px;
                margin-top: -480px;
            }

            .folder-info {
                padding: 2rem 1.5rem 1.5rem 1.5rem;
            }

            .folder-name {
                font-size: 1.6rem;
            }

            .folder-count {
                font-size: 1.25rem;
            }

            /* Adjust spacing for even larger cards */
            .folder-card.left-1 {
                transform: translateX(-440px) rotateY(40deg) scale(0.9) translateZ(-140px);
            }

            .folder-card.left-2 {
                transform: translateX(-720px) rotateY(50deg) scale(0.75) translateZ(-260px);
            }

            .folder-card.left-3 {
                transform: translateX(-940px) rotateY(60deg) scale(0.65) translateZ(-380px);
            }

            .folder-card.right-1 {
                transform: translateX(440px) rotateY(-40deg) scale(0.9) translateZ(-140px);
            }

            .folder-card.right-2 {
                transform: translateX(720px) rotateY(-50deg) scale(0.75) translateZ(-260px);
            }

            .folder-card.right-3 {
                transform: translateX(940px) rotateY(-60deg) scale(0.65) translateZ(-380px);
            }

            .nav-button {
                width: 80px;
                height: 80px;
                font-size: 2rem;
            }

            .browse-info {
                font-size: 1.1rem;
            }
        }

        /* Mobile and Small Screens */
        @media (max-width: 768px) {
            .browse-container {
                margin-top: 80px;
                height: calc(100vh - 80px);
            }

            .carousel-container {
                height: 624px;
                perspective: 1000px;
            }


            .folder-card {
                width: 312px;
                height: 480px;
                margin-left: -156px;
                margin-top: -240px;
            }

            .folder-card img {
                height: 384px;
            }

            .folder-info {
                padding: 0.75rem;
            }

            .folder-name {
                font-size: 1rem;
            }

            .folder-count {
                font-size: 0.85rem;
            }

            /* Bring cards closer and make them bigger/more visible */
            .folder-card.active {
                transform: translateX(0) rotateY(0deg) scale(1) translateZ(0);
            }

            .folder-card.left-1 {
                opacity: 1;
                transform: translateX(-180px) rotateY(35deg) scale(0.85) translateZ(-80px);
            }

            .folder-card.right-1 {
                opacity: 1;
                transform: translateX(180px) rotateY(-35deg) scale(0.85) translateZ(-80px);
            }

            .folder-card.left-2,
            .folder-card.left-3,
            .folder-card.right-2,
            .folder-card.right-3 {
                display: none;
            }

            .carousel-nav {
                display: none;
            }

            .browse-info {
                font-size: 0.85rem;
                padding: 0 1rem;
            }
        }
    </style>
</head>
<body>
    <nav>
        <a href="/">
            <div class="logo">
                <img src="/static/logo.svg" alt="Logo" onerror="this.src='https://via.placeholder.com/40'; this.onerror='';">
                <span>Browse Folders</span>
            </div>
        </a>
        <div class="filter-buttons">
            <!-- Theme toggle will be injected here by theme.js -->
        </div>
    </nav>

    <div class="browse-container">
        <div class="carousel-container" id="carouselContainer">
            <div class="carousel-wrapper" id="carouselWrapper">
                <!-- Folder cards will be injected here -->
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <div>Loading folders...</div>
                </div>
            </div>

            <!-- Navigation Arrows -->
            <div class="carousel-nav left" id="navLeft">
                <button class="nav-button" onclick="navigateCarousel(-1)">‹</button>
            </div>
            <div class="carousel-nav right" id="navRight">
                <button class="nav-button" onclick="navigateCarousel(1)">›</button>
            </div>
        </div>

        <div class="browse-info" id="browseInfo">
            Use arrow keys, mouse wheel, or swipe to navigate • Click to open folder
        </div>
    </div>

    <script>
        let folders = [];
        let currentIndex = 0;
        let touchStartX = 0;
        let touchEndX = 0;
        let isAnimating = false;

        // Fetch folders from API
        async function loadFolders() {
            try {
                const response = await fetch('/api/browse');
                const data = await response.json();

                if (data.success) {
                    folders = data.folders;
                    renderCarousel();
                    document.getElementById('loading').style.display = 'none';
                } else {
                    throw new Error(data.error || 'Failed to load folders');
                }
            } catch (error) {
                console.error('Error loading folders:', error);
                document.getElementById('loading').innerHTML = `
                    <div style="color: var(--text-primary);">Error loading folders</div>
                    <div style="font-size: 0.9rem; margin-top: 0.5rem;">${error.message}</div>
                `;
            }
        }

        // Render carousel cards
        function renderCarousel() {
            const wrapper = document.getElementById('carouselWrapper');
            wrapper.innerHTML = '';

            folders.forEach((folder, index) => {
                const card = document.createElement('div');
                card.className = 'folder-card intro';
                card.style.opacity = '0'; // Start invisible for intro animation
                card.innerHTML = `
                    <div class="folder-info">
                        <div class="folder-name">${folder.folder}</div>
                        <div class="folder-count">${folder.count} items</div>
                    </div>
                    <img src="${folder.thumbnail}" alt="${folder.folder}" loading="lazy">
                `;
                card.addEventListener('click', () => handleCardClick(index));
                wrapper.appendChild(card);
            });

            updateCarousel(true); // Skip transition on initial render

            // Remove intro class after animation completes
            setTimeout(() => {
                const cards = document.querySelectorAll('.folder-card');
                cards.forEach(card => {
                    card.classList.remove('intro');
                    card.style.opacity = ''; // Clear inline opacity
                });
            }, 1500); // Wait for all staggered animations to complete
        }

        // Update card positions based on current index
        function updateCarousel(skipTransition = false) {
            const cards = document.querySelectorAll('.folder-card');
            const total = folders.length;

            cards.forEach((card, index) => {
                // Calculate position relative to current index
                const diff = index - currentIndex;

                // Normalize diff to be in range [-total/2, total/2]
                let normalizedDiff = diff;
                if (diff > total / 2) {
                    normalizedDiff = diff - total;
                } else if (diff < -total / 2) {
                    normalizedDiff = diff + total;
                }

                // Remove all position classes
                card.className = 'folder-card';

                // Apply appropriate position class based on normalized difference
                if (normalizedDiff === 0) {
                    card.classList.add('active');
                } else if (normalizedDiff === -1) {
                    card.classList.add('left-1');
                } else if (normalizedDiff === -2) {
                    card.classList.add('left-2');
                } else if (normalizedDiff === -3) {
                    card.classList.add('left-3');
                } else if (normalizedDiff === 1) {
                    card.classList.add('right-1');
                } else if (normalizedDiff === 2) {
                    card.classList.add('right-2');
                } else if (normalizedDiff === 3) {
                    card.classList.add('right-3');
                } else {
                    card.classList.add('hidden');
                }
            });

            // Update info display
            if (folders.length > 0) {
                document.getElementById('browseInfo').textContent =
                    `${currentIndex + 1} / ${folders.length} • Use arrow keys, mouse wheel, or swipe to navigate • Click to open folder`;
            }
        }

        // Navigate to specific index with smooth transition
        function navigateToIndex(newIndex) {
            const total = folders.length;
            if (total === 0 || newIndex === currentIndex) return;

            // Prevent navigation if already animating
            if (isAnimating) return;
            isAnimating = true;

            const cards = document.querySelectorAll('.folder-card');

            // Hide cards that will wrap around
            cards.forEach((card, index) => {
                const currentDiff = index - currentIndex;
                const newDiff = index - newIndex;

                // Normalize differences
                const normCurrent = currentDiff > total/2 ? currentDiff - total :
                                   currentDiff < -total/2 ? currentDiff + total : currentDiff;
                const normNew = newDiff > total/2 ? newDiff - total :
                               newDiff < -total/2 ? newDiff + total : newDiff;

                // If card is moving from one visible side to the far opposite side
                const isWrapping = (Math.abs(normCurrent) <= 3 && Math.abs(normNew) > 3) ||
                                  (Math.abs(normCurrent) > 3 && Math.abs(normNew) <= 3);

                if (isWrapping) {
                    card.style.opacity = '0';
                    card.style.transition = 'none';
                }
            });

            // Small delay to ensure opacity is applied
            setTimeout(() => {
                currentIndex = newIndex;
                updateCarousel();

                // Restore transitions and fade in
                setTimeout(() => {
                    cards.forEach(card => {
                        card.style.transition = '';
                        card.style.opacity = '';
                    });

                    // Allow navigation again after transition completes
                    setTimeout(() => {
                        isAnimating = false;
                    }, 500); // Wait for CSS transitions to complete
                }, 50);
            }, 10);
        }

        // Navigate carousel by direction
        function navigateCarousel(direction) {
            const total = folders.length;
            if (total === 0) return;

            const newIndex = (currentIndex + direction + total) % total;
            navigateToIndex(newIndex);
        }

        // Handle card click
        function handleCardClick(index) {
            if (index === currentIndex) {
                // Center card clicked - navigate to folder
                const folder = folders[index].folder;
                window.location.href = `/gallery?folder=${encodeURIComponent(folder)}`;
            } else {
                // Side card clicked - center it smoothly
                navigateToIndex(index);
            }
        }

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                navigateCarousel(-1);
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                navigateCarousel(1);
            } else if (e.key === 'Enter' && folders.length > 0) {
                e.preventDefault();
                handleCardClick(currentIndex);
            }
        });

        // Touch/Swipe support
        const container = document.getElementById('carouselContainer');

        container.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });

        container.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, { passive: true });

        // Mouse drag support
        let isDragging = false;
        let dragStartX = 0;

        container.addEventListener('mousedown', (e) => {
            isDragging = true;
            dragStartX = e.clientX;
        });

        let isMouseDragging = false;

        container.addEventListener('mousemove', (e) => {
            // Parallax effect when not dragging
            if (!isDragging) {
                const rect = container.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                // Calculate rotation based on mouse position (centered)
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;

                const rotateY = ((x - centerX) / centerX) * 5; // Max 5 degrees
                const rotateX = -((y - centerY) / centerY) * 5; // Max 5 degrees

                const wrapper = document.getElementById('carouselWrapper');
                wrapper.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
            } else {
                e.preventDefault();
            }
        });

        container.addEventListener('mouseup', (e) => {
            if (!isDragging) return;
            isDragging = false;

            const dragEndX = e.clientX;
            const diff = dragStartX - dragEndX;

            // Threshold for drag to count as swipe
            if (Math.abs(diff) > 50) {
                navigateCarousel(diff > 0 ? 1 : -1);
            }
        });

        container.addEventListener('mouseleave', () => {
            isDragging = false;
            // Reset parallax effect
            const wrapper = document.getElementById('carouselWrapper');
            wrapper.style.transform = '';
        });

        // Mouse wheel navigation with throttling
        let lastWheelTime = 0;
        container.addEventListener('wheel', (e) => {
            e.preventDefault();

            // Throttle wheel events - ignore if animation in progress or too soon after last wheel
            const now = Date.now();
            if (isAnimating || now - lastWheelTime < 400) {
                return;
            }

            lastWheelTime = now;

            if (e.deltaY > 0) {
                // Scroll down - next
                navigateCarousel(1);
            } else if (e.deltaY < 0) {
                // Scroll up - previous
                navigateCarousel(-1);
            }
        }, { passive: false });

        function handleSwipe() {
            const diff = touchStartX - touchEndX;

            // Minimum swipe distance (50px)
            if (Math.abs(diff) > 50) {
                if (diff > 0) {
                    // Swipe left - next
                    navigateCarousel(1);
                } else {
                    // Swipe right - previous
                    navigateCarousel(-1);
                }
            }
        }

        // Load folders on page load
        document.addEventListener('DOMContentLoaded', loadFolders);
    </script>
</body>
</html>
